# A-F-01 File Analysis by Exporting the Cluster Status

To persist the status of the Kubernetes cluster stored in the key value store and use it for further analysis, it should first be backed up outside the cluster. For this purpose, the ``cluster-info dump`` option of the ``kubectl`` command-line interface can be used, which outputs the entire state of the cluster in JSON format [[The24t](https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cluster-info/kubectl_cluster-info_dump/)].

However, the information obtained in this way does not readily allow the cluster state to be replicated in a dedicated analysis environment, where, for example, further analysis can be carried out or the effects of mitigation measures can be tested. For this, a complete copy of the data in the key value store is required [[The23ag](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/)]. This necessary copy can be created without much effort by backing up the etcd component, which can then be used in a dedicated analysis environment to restore the state of the cluster [[The23ag](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/)]. Specifically, this copy can be created using the ``etcdctl`` command-line tool, which is directly integrated with the etcd cluster and can thus create a backup of the data it contains [[The23ag](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/)].

It is important to note that the etcd cluster does not necessarily have to run on the same nodes as the Kubernetes cluster, but is often implemented on other servers as a so-called external etcd component [[The23n](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/)]. Therefore, when using the ``etcdctl`` command-line tool, it is crucial to specify the correct network endpoints [[The23ag](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/)].

Aside from installing the command-line tool following the instructions in [[etc23b](https://etcd.io/docs/v3.5/install/)], a backup of the etcd component can be created as follows:

1. Create a backup of the data in the etcd component using the commands from Listing 1, lines 1 to 2 [[The23ag](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/);[etc23a](https://etcd.io/docs/v3.6/tutorials/how-to-save-database/)].
   - In the process, the appropriate certificates, keys, and endpoint for connecting to the etcd cluster must be inserted before execution. However, only one node of the etcd cluster needs to be specified [[etc23a](https://etcd.io/docs/v3.6/tutorials/how-to-save-database/)].

2. Restore the cluster state if a dedicated analysis environment is available (see Listing 1, line 3) [[The23ag](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/)].
   - In this way, the state of the Kubernetes cluster can be restored multiple times based on the backup.
   - However, the command in line 3 only creates a local copy of the key value data, so no authentication data is required. To use the data in the analysis environment, it must be transferred there and the etcd container configured as described in [[The23ag](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/)].
   - It is important to note that only the data stored in the key value store will be transferred, and no application data will be transferred to the analysis environment. Therefore, data stored via StatefulSets, etc., must be transferred to the analysis environment separately.

###### Listing 1: Commands for creating a backup of the etcd component by [[The23ag](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/);[etc23a](https://etcd.io/docs/v3.6/tutorials/how-to-save-database/)]
```bash
export ETCDCTL_API=3
sudo -E etcdctl snapshot save --endpoints=<IP address of a node>:2379 --cacert=<Path to the certificate of the CA> --cert=<Path to the certificate of the etcd container> --key=<Path to the key of the etcd container> snapshot.db
sudo -E etcdctl snapshot restore --data-dir=<Path to the local folder> snapshot.db
```

## Evaluation

The following table, entitled *Evaluation of measure A-F-01*, provides an overview of the evaluation of the aforementioned measure. The composition of the overall rating is then described in detail.

#### Table: Evaluation of A-F-01

| Criteria           | Result |
| ------------------ | ------ |
| Applicability      | 4      |
| Preparation Effort | 5      |
| Complexity         | 5      |
| Coverage           | 1      |
| Business Impact    | 5      |
| Visibility         | 5      |
| Resilience         | 2      |
| Reproducibility    | 5      |
| Interoperability   | 3      |
| Overall Rating     | 4,00   |

To evaluate this measure, an attempt was made in each of the test scenarios to create a backup of the key value store using the aformentioned instructions. The successful creation of the backup was verified using the command from Listing 2, and no external recovery of the cluster state was performed.

In the process, a backup was successfully created in three out of the four test scenarios, indicating a high applicability of the measure, rated at 4. However, no backup could be created within K3s, as the key value store used is incompatible with the approach presented [[The23bg](https://www.sqlite.org/backup.html)]. At the same time, the reproducibility of the measure is very high (5), as a backup was successfully created in each of the five attempts.

The backup is in an undocumented format, which, along with the high practicality of the binary format, leads to a satisfactory interoperability (3) of the results according to the evaluation scheme used. Regardless, the measure has a very low preparation effort (5) and a very low complexity (5), as only the ``etcdctl`` command-line tool needs to be installed, and the data backup can be easily performed via the central interface of the etcd cluster.

In this context, however, depending on the applications used, greater effort may be required to restore the cluster state, which could not be considered here. Additionally, both the business impact and the visibility of the measure are very low (5), as the creation of a backup has no operational impact (see Figure 1), and restoration occurs entirely independently of the compromised cluster in a dedicated analysis environment.

However, this measure has only sufficient resilience (2), as attackers can easily implement their cryptominers as static containers, which are recognized by the API server and stored in the Key Value Store but are not easily restored by the Kubelet in the dedicated analysis environment using the methods described. Moreover, the backup of the cluster state using ``etcdctl`` has a very low coverage (1), as only artifacts related to the TTPs T1136 [[The23aw](https://attack.mitre.org/techniques/T1136/)], T1070 [[The23az](https://attack.mitre.org/techniques/T1070/)], and T1496 [[The23bc](https://attack.mitre.org/techniques/T1496/)] are saved, and no evidence of potential attacker actions before privilege escalation is available [[The23d](https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/)]. This is because neither the workload logs nor the API server logs are saved in the key value store without additional configuration [[The23aa](https://kubernetes.io/docs/concepts/cluster-administration/logging/)], meaning only indications of possible changes to the cluster can be collected.

Nevertheless, an overall good rating (4.00) was given.


##### Listing 2: Command for checking the backup of the etcd component by [[The23ag](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/)]

```bash
sudo -E etcdctl --write-out=table snapshot status <Path to the backup>
```

##### Figure 1: Business impact of measure A-F-01
![Business impact of measure A-F-01](Dependency-Modeling-Diagram_A-F-01.png)