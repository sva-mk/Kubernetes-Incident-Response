# A-F-02 File Analysis using VirusTotal

In addition to backing up and analyzing the key value store, it is equally important during file analysis to examine individual file artifacts within the compromised pod, especially focusing on files that could potentially be malicious software samples [[Tho18, p.101ff](https://link.springer.com/book/10.1007/978-1-4842-3870-7)].

In the context of the attack scenario considered here, it makes sense to investigate all files that have been modified or added within the compromised container. In this regard, there are several methods to examine both the basic properties (static analysis) and the behavior (dynamic analysis) of the suspicious files [[MPM14, p.550ff](http://cisweb.bristolcc.edu/~ik/Download/Forensic/Incident_Response_Computer_Forensics_3rd_Edition.pdf);[Tho18, S.101ff](https://link.springer.com/book/10.1007/978-1-4842-3870-7)].

A common approach for performing static and dynamic file analysis is the use of online services like "VMRay" [[VMR24](https://www.vmray.com/)] or "VirusTotal" [[Vir24b](https://www.virustotal.com/gui/home/upload)], which typically offer automated analysis environments where files can be uploaded for analysis through various methods [[Tho18, S.101ff](https://link.springer.com/book/10.1007/978-1-4842-3870-7)].

However, it should be noted that uploaded files often remain in the database of the respective online service and may be made available to third parties [[Vir24a](https://docs.virust{otal.com/docs/private-scanning)], which can be problematic from a privacy perspective [[Bun24](https://www.bmwk.de/Redaktion/DE/Artikel/Digitale-Welt/europaeische-datenschutzgrundverordnung.html)].

It is therefore not advisable to directly upload every suspicious file to an online service. Instead, it should first be checked whether the file has already been analyzed before considering uploading it for further analysis. VirusTotal offers the option to search its database for previous analyses of a file based on its hash value, allowing earlier analysis results to be used for a detailed investigation of the properties and behavior of a suspected malware sample [[Vir23a](https://docs.virustotal.com/reference/file-info)].

The following describes an approach that, using the command-line tool "nerdctl" [[Con24](https://github.com/containerd/nerdctl)], enables the identification of modified files in one or more pods and then queries previous analysis results through the VirusTotal API. The following preparations are necessary:

1. Installation of ``nerdctl`` (see Listing 1, lines 1 to 3) [[Con24](https://github.com/containerd/nerdctl)].
   - The ``nerdctl`` command-line tool must be installed on each node to locally access the container runtime [[Con24](https://github.com/containerd/nerdctl)].
   - The ``nerdctl`` tool supports all functions also provided by the "Docker CLI" [[Doc24e](https://docs.docker.com/engine/reference/commandline/cli/)] for the local operation of containerized applications [[Con24](https://github.com/containerd/nerdctl)].

2. Acquisition of a VirusTotal license in the form of an API key [[Vir20](https://docs.virustotal.com/reference/authentication)].
   - For non-commercial use, a free user account is sufficient [ [Vir23b](https://docs.virustotal.com/reference/public-vs-premium-api)]. However, for commercial use, a paid license must be obtained [ [Vir23b](https://docs.virustotal.com/reference/public-vs-premium-api)].

After completing these preparations, it is possible to identify the modified files of a pod using the following procedure and retrieve previous analysis results via the VirusTotal API. It is assumed that a suspicious pod has already been identified during the detection of the cryptojacking incident:

1. Establish an SSH connection to the node where the suspicious pod is running (see Listing 1, line 4) [[Ama23a](https://aws.github.io/aws-eks-best-practices/security/docs/incidents/)].
   - Before executing, the name and namespace of the previously identified pod, as well as the username for connecting to the respective node, must be added.

2. Retrieve the local containers via the container runtime (see Listing 1, line 5) [[Con24](https://github.com/containerd/nerdctl)].
   - It is important to note that ``nerdctl`` can only be used with the containerd runtime [[Con24](https://github.com/containerd/nerdctl)]. Additionally, the "containerd socket address" [[Con24](https://github.com/containerd/nerdctl)] must be defined, serving as the interface for interacting with the container runtime.

3. Check for changes in the filesystem of a container (see Listing 1, line 6) [[Con24](https://github.com/containerd/nerdctl)].
   - The output of this action shows added (A), deleted (D), and changed (C) files [[Con24](https://github.com/containerd/nerdctl);[Doc24a](https://docs.docker.com/engine/reference/commandline/container_diff/)].

4. Export all artifacts relevant for analysis and documentation (see Listing 1, lines 7 to 8) [[The23u](https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cp/)].

5. Generate hash values for the extracted artifacts (see Listing 1, line 9).

6. Query previous analysis results via the VirusTotal API for the respective hash values of the artifacts (see Listing 1, lines 10 to 11) [[Vir20](https://docs.virustotal.com/reference/authentication);[Vir23a](https://docs.virustotal.com/reference/file-info)].
   - It is possible that no previous analysis results exist for a given hash value. In this case, it should be carefully considered whether the file can be uploaded to VirusTotal for analysis [[Vir24b](https://www.virustotal.com/gui/home/upload)].

##### Listing 1: Commands for analysing relevant files with VirusTotal by [[Con24](https://github.com/containerd/nerdctl)][[Vir23a](https://docs.virustotal.com/reference/file-info)]

```bash
wget https://github.com/containerd/nerdctl/releases/download/v1.7.2/nerdctl-1.7.2-linux-amd64.tar.gz
tar -zxf nerdctl-1.7.2-linux-amd64.tar.gz nerdctl
sudo mv nerdctl /usr/bin/nerdctl
ssh <user>@$(kubectl get node $(kubectl get pod -n <namespace> <pod> -o=jsonpath='{.spec.nodeName}') -o=jsonpath='{.status.addresses[?(@.type=="InternalIP")].address}')
sudo nerdctl --address=<Path to the container runtime socket> --namespace=k8s.io ps`
sudo nerdctl --address=<Path to the container runtime socket> --namespace=k8s.io diff <container-id>
LOCAL_FILE_PATH="<Path to the local file>"
kubectl cp  <pod-name>:<Path to the file in the container> -c <container-name> $LOCAL_FILE_PATH
FILE_HASH=$(sha256sum $LOCAL_FILE_PATH | awk '{print $1}')
VT_API_KEY="<API Key>"
VT_API_URL="https://www.virustotal.com/api/v3/files/$FILE_HASH"
```

## Evaluation

The following table, entitled *Evaluation of measure A-F-02*, provides an overview of the evaluation of the aforementioned measure. The composition of the overall rating is then described in detail.

#### Table: Evaluation of A-F-02

| Criteria           | Result |
| ------------------ | ------ |
| Applicability      | 3      |
| Preparation Effort | 3      |
| Complexity         | 3      |
| Coverage           | 4      |
| Business Impact    | 5      |
| Visibility         | 5      |
| Resilience         | 3      |
| Reproducibility    | 5      |
| Interoperability   | 4      |
| Overall Rating     | 3,85   |

To carry out this measure, changes in the file system of a web server pod were read in each test scenario, and the web server configuration was subsequently extracted. Previous analysis results were then queried via the VirusTotal API. It was found that the described procedure was successfully executed in three of the four test scenarios. However, this measure was not easily applicable in the context of OpenShift, as ``nerdctl`` is not compatible with OpenShift's container runtime [[Con24](https://github.com/containerd/nerdctl)]. Along with the lack of integration into the Kubernetes API, this results in a moderate applicability rating (3).

Nevertheless, the reproducibility of this measure is very high (5), as each of the five executions successfully identified that the web server configuration had been altered and identical analysis results could be retrieved via the VirusTotal API.

The results of this measure exhibit high interoperability (4), as VirusTotal analysis results are output in JSON format, and the exact data structure can be found in the public documentation [[Vir23a](https://docs.virustotal.com/reference/file-info)]. Additionally, the measure involves a satisfactory level of preparation (3), as acquiring a VirusTotal license and a more elaborate setup is required. The complexity of the measure is also satisfactory (3), given that six actions must be executed overall, though conducting the file analysis using VirusTotal is not particularly challenging [[MPM14, p.569](http://cisweb.bristolcc.edu/~ik/Download/Forensic/Incident_Response_Computer_Forensics_3rd_Edition.pdf)]. Despite this complexity, both the business impact and visibility of the measure are very low (5), as there is no operational impact (see Figure 1), and no changes are made to the file system or other components of the compromised cluster.

The coverage of the measure is high (4), as the file analysis via VirusTotal can identify IoCs for the TTPs T1190 [[The23ax](https://attack.mitre.org/techniques/T1190/)], T1068 [[The23ay](https://attack.mitre.org/techniques/T1068/)], T1070 [[The23az](https://attack.mitre.org/techniques/T1070/)], and T1496 [[The23bc](https://attack.mitre.org/techniques/T1496/)], allowing cryptojacking incidents to be clearly detected in the early stages of the attack. However, the effectiveness of the measure can be reduced relatively easily through techniques such as "Reflective Code Loading" [[The23bb](https://attack.mitre.org/techniques/T1620/)], where malware is executed entirely without affecting the file system context. Therefore, the measure has only moderate resilience (3). In total, a overall rating of 3.85 was awarded.

##### Figure 1: Business impact of measure A-F-02
![Business impact of measure A-F-02](Dependency-Modeling-Diagram_A-F-02.png)