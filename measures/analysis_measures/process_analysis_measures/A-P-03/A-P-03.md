# A-P-03: Process Analysis using Tracee

As an alternative to analysing running processes using a forensic container image or the THOR-Lite analysis tool, these processes can also be examined in more detail using the "Observability Tool [...] Tracee" [[Aqu24f](https://aquasecurity.github.io/tracee/latest/)]. The Tracee analysis tool was developed specifically for use in Kubernetes and can be used in both the detection and analysis phases to identify initial events and to learn more about an incident during the analysis phase [[Aqu24f](https://aquasecurity.github.io/tracee/latest/)].
This is possible because, unlike other detection tools such as "Falco" [[The24l](https://falco.org/docs/)], Tracee provides significantly more information and functionality for process analysis [[Aqu24b](https://aquasecurity.github.io/tracee/v0.19/docs/advanced/forensics/)]. In particular, many detection tools already allow for the prioritisation of an event to provide an initial assessment of the severity of the event [[The23c](https://falco.org/docs/rules/basic-elements/);[Ins24](https://www.ias.edu/security/priority-and-severity-levels)]. Tracee, on the other hand, provides additional information beyond severity classification, such as direct mapping to which MITRE ATT&CK Matrix technique the event corresponds and a detailed description of how the event indicates an incident [[Aqu24e](https://aquasecurity.github.io/tracee/v0.19/docs/events/builtin/signatures/)]. It also allows detailed analysis of specific pods by creating special security rules for them and extracting individual artefacts. However, this work focuses only on the basic analysis of the processes in the cluster according to the following procedure [[Aqu24c](https://aquasecurity.github.io/tracee/v0.19/docs/install/kubernetes/);[Aqu24d](https://aquasecurity.github.io/tracee/latest/docs/policies/scopes/)]:

1. Installation of Tracee using "Helm" [[Hel24](https://helm.sh/docs/intro/quickstart/)] (see Listing 1, lines 1 to 3) [[The22c](https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/);[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/)].

   - Helm is a package manager for Kubernetes that can be used to configure and install various applications in the Kubernetes environment [[Hel24](https://helm.sh/docs/intro/quickstart/)].
   - Helm is often already used for managing workloads and other auxiliary applications [[Sch23](https://circleci.com/blog/what-is-helm/);[Col24](https://github.com/collabnix/kubetools)]. If this is not the case, the package manager can be installed during the preparation without much effort [[Hel24](https://helm.sh/docs/intro/quickstart/)].

2. Reading Tracee results for further analysis of active processes in the cluster (see Listing 1, line 4).

   - During installation, a DaemonSet is set up that runs an instance of Tracee on each node and automatically starts analyzing the processes [[Aqu24c](https://aquasecurity.github.io/tracee/v0.19/docs/install/kubernetes/)].
   - Essentially, all analysis results are displayed by the command in line 4, but it may take some time for the results to sync. Therefore, it may be advantageous to retrieve the logs of the individual Tracee containers directly (see Listing 1, lines 5 to 6).

3. Creating additional analysis rules to gain deeper insights into the running pods and their processes based on the publicly documented capabilities of Tracee [[Aqu24a](https://aquasecurity.github.io/tracee/v0.19/docs/events/custom/overview/)].

   - In addition to the pods, other Kubernetes objects can also be investigated and analyzed with special rules if necessary [[Aqu24d](https://aquasecurity.github.io/tracee/latest/docs/policies/scopes/)].

4. Extracting the found artifacts for the best possible documentation of the analysis [[Aqu24b](https://aquasecurity.github.io/tracee/v0.19/docs/advanced/forensics/)].
   - Specifically, files, memory, all network packets, and loaded kernel modules associated with identified events can be extracted [[Aqu24b](https://aquasecurity.github.io/tracee/v0.19/docs/advanced/forensics/)].
   - For example, all executed files can be secured with the command in lines 7 to 10.

##### Listing 1: Commands for Process Analysis Using Tracee According to [[Aqu24c](https://aquasecurity.github.io/tracee/v0.19/docs/install/kubernetes/); [Aqu24d](https://aquasecurity.github.io/tracee/latest/docs/policies/scopes/)]

```bash
helm repo add aqua https://aquasecurity.github.io/helm-charts/
helm repo update
helm install tracee aqua/tracee --namespace tracee --create-namespace
kubectl logs --follow --namespace tracee daemonset/tracee
kubectl get pods -n tracee
kubectl logs -n tracee <podname>
kubectl exec -n tracee <podname> -it -- /tracee/tracee \
--output json --scope comm=bash --scope follow \
--output option:parse-arguments --capture dir:/tmp/tracee/ \
--capture exec
```

## Evaluation

The following table, entitled '_Evaluation of measure A-P-03_', provides an overview of the evaluation of the aforementioned measure. The composition of the overall rating is then described in detail.

#### Table: Evaluation of A-P-03

| Criteria           | Result |
| ------------------ | ------ |
| Applicability      | 4      |
| Preparation Effort | 4      |
| Complexity         | 2      |
| Coverage           | 4      |
| Business Impact    | 5      |
| Visibility         | 4      |
| Resilience         | 4      |
| Reproducibility    | 5      |
| Interoperability   | 2      |
| Overall Rating     | 4,00   |

To evaluate the measure, it was carried out as described above and then checked with the 'Tracee-Tester' tool [[Aqu24c](https://aquasecurity.github.io/tracee/v0.19/docs/install/kubernetes/)] to ascertain whether the basic analysis function was fully functional (see Listing 2).
The results demonstrate that the measure has a high degree of applicability (4), as it can be carried out via the Kubernetes API and was successfully implemented in three of the four test scenarios.
In particular, the analysis tool in the Rancher test scenario was unable to identify the event initiated by the Tracee Tester with the identifier 'TRC-105'. This is because Tracee requires specific permissions for execution, which cannot be readily assigned in conjunction with the hardened Rancher environment [[Aqu24c](https://aquasecurity.github.io/tracee/v0.19/docs/install/kubernetes/)].
Nevertheless, the measure exhibits an exceptionally high degree of reproducibility (5), as evidenced by the fact that the analysis tool consistently produced identical results across all five executions, with the event triggered by the tracee tester being correctly identified in each case.
The preparation effort for the measure is minimal (4), requiring only the installation of the package manager Helm if it is not already present.
Conversely, the complexity of the measure is high (2), as the correct interpretation of Tracee's output necessitates a high level of expertise and a maximum of four steps.

Furthermore, the measure exhibits a high degree of coverage (4), as the analysis encompasses TTPs T1190 [[The23ax](https://attack.mitre.org/techniques/T1190/)], T1528 [[The23bd](https://attack.mitre.org/techniques/T1528/)], T1069 [[The23ba](https://attack.mitre.org/techniques/T1069/)], T1068 [[The23ay](https://attack.mitre.org/techniques/T1068/)], T1613 [[The23au](https://attack.mitre.org/techniques/T1613/)] and T1496 [[The23bc](https://attack.mitre.org/techniques/T1496/)] , which can be identified by the cluster and the artefacts can be extracted by it [[Aqu24e](https://aquasecurity.github.io/tracee/v0.19/docs/events/builtin/signatures/);[Aqu24b](https://aquasecurity.github.io/tracee/v0.19/docs/advanced/forensics/)].
Concurrently, the business impact (5) and resilience (4) are identical to the previous measure, as shown in Figure 1 there is no operational impact on the Kubernetes cluster and circumventing the comprehensive rules of the analysis tool requires considerable effort.
Because Tracee is integrated into the process context through the use of eBPF" [[Aqu24f](https://aquasecurity.github.io/tracee/latest/)], and because some malware variants now analyse the cluster environment to determine whether the above method is being used, this measure is characterised by low visibility (4) [[Red23d](https://www.ired.team/offensive-security/defense-evasion/detecting-hooked-syscall-functions)].
In principle, the results of the measure are available in JSON format; however, the structure of the logs is not congruent with that of other analysis and detection tools.
The analysis results can only be extracted from the logs of the pods, whereby delays can occur in the context of the synchronisation of entries and no external interfaces can be addressed directly, as is possible with Falco, for example. [[The24l](https://falco.org/docs/)].
The interoperability of the results can therefore be categorised as low (2).
Overall, the measure was rated as good (4.00).

##### Listing 2: Command for checking tracee according to [[Aqu24c](https://aquasecurity.github.io/tracee/v0.19/docs/install/kubernetes/)]

```bash
kubectl run tracee-tester --image=aquasec/tracee-tester -- TRC-105
```

##### Figure 1: Business impact of measure A-P-03
![Business impact of measure A-P-03](Dependency-Modeling-Diagram_A-P-03.png)