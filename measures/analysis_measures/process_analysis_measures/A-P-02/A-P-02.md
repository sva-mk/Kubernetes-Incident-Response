# A-P-02: Process Analysis using THOR-Lite

In addition to creating and analyzing a forensic container image, the active processes of a compromised pod can also be investigated in other ways. For example, the analysis tool "THOR-Lite" [[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/)] from Nextron Systems GmbH is already being used for process analysis in containerized environments [[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/);[OKN23](https://link.springer.com/chapter/10.1007/978-3-658-41614-0_16)].

Fundamentally, it enables automated analysis of the process context by providing an extensive database of IoCs, which can be used to examine the processes and their associated memory regions [[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/);[OKN23](https://link.springer.com/chapter/10.1007/978-3-658-41614-0_16);[Nex23b](https://www.nextron-systems.com/thor-lite/)]. Additionally, the tool is based on over 4,000 [YARA](https://yara.readthedocs.io/en/stable/index.html) rules, allowing the examination of running processes and their memory areas for characteristic obfuscation attempts, suspicious network connections, and questionable strings [[Nex23a](https://www.nextron-systems.com/compare-our-scanners/)].

Moreover, the tool is compatible with most hardware and software platforms [[Nex23b](https://www.nextron-systems.com/thor-lite/)] and can therefore be executed both within a pod and directly on the nodes of the cluster. However, since this work focuses on cryptojacking incidents where the nodes have not been further compromised, only the capabilities of the analysis tool directly within the pods are considered in this study. Additionally, a valid license is required to run the tool, but this can be obtained for free with minimal effort during the preparation phase, as long as the tool is not used commercially.

In principle, this tool is capable of analyzing not only processes but also the entire file context of a container. However, this would require an alternative approach, which would have a significantly greater impact on the cluster and the workloads running within it. Therefore, this work focuses solely on process analysis using the following procedure:

1. Create an ephemeral container that is connected to the compromised pod via the same "process namespace" [[The23aq](https://kubernetes.io/docs/tasks/configure-pod-container/share-process-namespace/)] (see Listing 1, line 1) [[The22c](https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/);[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/)].
   - Through so-called "process namespace sharing" [[The23aq](https://kubernetes.io/docs/tasks/configure-pod-container/share-process-namespace/)], the ephemeral container can access the processes of the compromised pod
   - Additionally, the original pod is internally replicated by the ``--copy-to`` option, and the ephemeral container is inserted into the copied pod, ensuring that the original pod is not altered by this measure [[The22c](https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/);[The23aq](https://kubernetes.io/docs/tasks/configure-pod-container/share-process-namespace/)].

2. Extract the analysis tool and activate the license (see Listing 1, lines 2 to 3) [[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/)].
   - Since many containers do not contain tools for unpacking software archives [[The22c](https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/)], this must be done explicitly before transferring into the ephemeral container.

3. Transfer the activated analysis tool to the created ephemeral container (see Listing 1, line 4) [[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/)].
   - By using ``kubectl cp``, it is not necessary to transfer the data to individual nodes of the cluster. Instead, the data is directly transferred to the container via the Kubernetes API [[The23u](https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cp/)].

4. Execute the analysis tool in the ephemeral container (see Listing 1, line 5) [[The22c](https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/);[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/)].

5. Secure the analysis results (see Listing 1, lines 6 to 9) [[The23u](https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cp/);[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/)].

###### Listing 1: Commands for process analysis using the THOR-Lite analysis tool according to [[The22c](https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/);[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/)]

```bash
kubectl debug <pod-name> -it --image ubuntu --share-processes --copy-to debug -c
debugger --attach=false
unzip thor-lite.zip -d ./thor
cp <Path to Thor-Lite license> ./thor
kubectl cp thor/. debug:/thor -c debugger
kubectl exec debug -c debugger -- ./thor/thor-lite-linux-64
kubectl exec debug -c debugger -- ls /
kubectl cp debug:debug_files_md5s.csv -c debugger ./debug_files_md5s.csv
kubectl cp debug:debug_thor_<date>.html -c debugger ./debug_thor_<date>.html
kubectl cp debug:debug_thor_<date>.txt -c debugger ./debug_thor_<date>.txt
```

## Evaluation

The following table, entitled '_Evaluation of measure A-P-02_', provides an overview of the evaluation of the aforementioned measure. The composition of the overall rating is then described in detail.

#### Table: Evaluation of A-P-02

| Criteria           | Result |
| ------------------ | ------ |
| Applicability      | 4      |
| Preparation Effort | 4      |
| Complexity         | 3      |
| Coverage           | 4      |
| Business Impact    | 5      |
| Visibility         | 3      |
| Resilience         | 4      |
| Reproducibility    | 5      |
| Interoperability   | 4      |
| Overall Rating     | 4,15   |

The process analysis using THOR-Lite was fundamentally conducted on a web server pod in the experimental environment, as previously described. The results show that the measure offers high applicability (4), as THOR-Lite was successfully used in three of the four test scenarios to analyse the web server, with the measure being directly executable through the Kubernetes API. Furthermore, the measure has a very high reproducibility (5), as it was performed five times with identical results.

At the same time, the preparation effort for carrying out the measure is low (4), as obtaining the license can be costly in a commercial environment but still requires only a few actions [[Nex23b](https://www.nextron-systems.com/thor-lite/)]. The use of the analysis tool THOR-Lite involves medium complexity (3) due to the manageable number of necessary actions, although executing the measure requires an understanding of the context but not in-depth expertise.

Additionally, the measure shows a high coverage (4) since the analysis tool can identify IoCs for the TTPs T1190 [[The23ax](https://attack.mitre.org/techniques/T1190/)], T1528
[[The23bd](https://attack.mitre.org/techniques/T1528/)], T1613 [[The23au](https://attack.mitre.org/techniques/T1613/)], T1068 [[The23ay](https://attack.mitre.org/techniques/T1068/)], T1069 [[The23ba](https://attack.mitre.org/techniques/T1069/)] und T1496 [[The23bc](https://attack.mitre.org/techniques/T1496/)] within the pods, thus enabling the detection of the first elements of a cryptojacking attack [[Nex23b](https://www.nextron-systems.com/thor-lite/)].

Notable are the very low business impact (5) and the high resilience (4) of the measure, with the former being clearly illustrated in Figure 1. The high resilience stems from the fact that while the YARA rules for detecting IoCs and the indicators themselves are publicly available, deceiving the analysis tool is still associated with significant effort, as these rules are based on typical characteristics of malware and not necessarily on the exact identification of individual IoCs [[Rot24](https://github.com/Neo23x0/signature-base);[Nex23b](https://www.nextron-systems.com/thor-lite/)]. The malware used would therefore need to be explicitly adapted to the analysis tool, which is only possible with considerable effort and the corresponding expert knowledge. Additionally, the IoC database and the included rules are regularly updated, making it significantly more difficult to adapt the malware accordingly [[Rot24](https://github.com/Neo23x0/signature-base)].

The measure also shows medium visibility (3), as no direct changes are made to the compromised pods, but the file and process context is altered by loading the analysis tool into the pod and analyzing the processes there. Furthermore, the analysis results of this measure demonstrate high interoperability (4) as both an HTML report and a copy of the command line output in TXT format are available, and additional information can be provided in CSV format for further processing [[Hag23](https://www.nextron-systems.com/2023/05/04/how-to-scan-docker-containers-using-thor-part-2/)].

In summary, the measure was therefore assigned a good overall rating (4.15).

##### Figure 1: Business impact of measure A-P-02
![Business impact of measure A-P-02](Dependency-Modeling-Diagram_A-P-02.png)