# C-N-02 Partial Network Isolation of Applications

The previously introduced measure of full network isolation prevents the use of the affected application, as it is no longer accessible over the network. However, this approach is not always practical, especially since in the attack scenario under consideration, the Kubernetes cluster is still fundamentally functional, meaning the compromised application remains accessible before the containment measure is applied.

In conjunction with the Cilium network plugin, there are several options to implement partial network isolation instead of complete isolation [[The23a](https://docs.cilium.io/en/stable/security/policy/#network-policy);[The24h](https://docs.cilium.io/en/latest/observability/visibility/)]. Specifically, by using a "CiliumNetworkPolicy" [[The23a](https://docs.cilium.io/en/stable/security/policy/#network-policy)] instead of a native network policy, it is possible to implement a set of granular rules at the application level [[The24j](https://docs.cilium.io/en/stable/network/kubernetes/policy/); [Jau23](https://learncloudnative.com/blog/2023-06-14-cilium-network-policy)]. This allows certain network connections with specific properties to be selectively permitted. For example, requests using the HTTP method ``POST`` can be blocked entirely.

Additionally, with the CiliumNetworkPolicy from Listing 2, it is possible to prohibit all outgoing connections except for requests to [http://google.com](https://www.google.com/), including filtering DNS queries related to the Google domain. Moreover, this network policy only allows HTTP methods ``GET`` and ``HEAD``, effectively blocking ``POST`` requests to Google. Furthermore, connections to or from individual IP address ranges can be explicitly allowed or denied, and these rules can be combined with various application-level rules [[The24j](https://docs.cilium.io/en/stable/network/kubernetes/policy/); [Jau23](https://learncloudnative.com/blog/2023-06-14-cilium-network-policy); [The24h](https://docs.cilium.io/en/latest/observability/visibility/)].

The following outlines a procedure that enables partial restriction of network traffic, with preparatory actions including the installation of the Cilium command-line interface according to the instructions in [[The24c](https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/)]:

1. Verify Cilium's functionality (see Listing 1 line 1) [[The24c](https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/)].

    - The goal of this action is to check whether Cilium is fundamentally operational and whether all containers are being managed by Cilium [[The24c](https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/)]. An example output for verifying these aspects is shown in Figure 1.


2. Identify the respective labels and the necessary connections for the proper operation of the compromised application [[The24j](https://docs.cilium.io/en/stable/network/kubernetes/policy/); [Jau23](https://learncloudnative.com/blog/2023-06-14-cilium-network-policy); [The24h](https://docs.cilium.io/en/latest/observability/visibility/)].

     - For this, analysis measure A-N-02 can be used to identify relevant connections as an alternative to internal organizational documentation.
     - A corresponding CiliumNetworkPolicy should then be created or an appropriate template should be adapted.

3. Set up the CiliumNetworkPolicy to prevent all unauthorized connections (see Listing 1 line 2) [[The24j](https://docs.cilium.io/en/stable/network/kubernetes/policy/); [Jau23](https://learncloudnative.com/blog/2023-06-14-cilium-network-policy); [The24h](https://docs.cilium.io/en/latest/observability/visibility/)].

##### Listing 1:  Commands for partial network isolation at application level according to  [[The24j](https://docs.cilium.io/en/stable/network/kubernetes/policy/); [Jau23](https://learncloudnative.com/blog/2023-06-14-cilium-network-policy); [The24h](https://docs.cilium.io/en/latest/observability/visibility/)]

```bash
cilium status --wait --wait-duration 5s
kubectl apply -f CiliumNetworkPolicy.yaml
```

##### Listing 2: YAML configuration for partial network isolation of an application according to [[The24j](https://docs.cilium.io/en/stable/network/kubernetes/policy/); [Jau23](https://learncloudnative.com/blog/2023-06-14-cilium-network-policy); [The24h](https://docs.cilium.io/en/latest/observability/visibility/)]

```bash
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
    name: l7-visibility
spec:
    endpointSelector:
    matchLabels:
        "k8s:io.kubernetes.pod.namespace": default
    egress:
    - toPorts:
    - ports:
        - port: "80"
        protocol: TCP
        rules:
        http:
        - method: "GET"
    - toPorts:
    - ports:
        - port: "53"
        protocol: UDP
        rules:
        dns:
        - matchPattern: "google.com"
```


##### Figure 1: Status output from Cilium to check functionality according to [[The24k](https://docs.cilium.io/en/stable/gettingstarted/hubble_setup/)]
![ Status output from Cilium to check functionality according to [The24k]](Cilium_status.png)


## Evaluation

The following table, entitled *Evaluation of measure C-N-02*, provides an overview of the evaluation of the aforementioned measure. The composition of the overall rating is then described in detail.

#### Table: Evaluation of C-N-02

| Criteria           | Result |
| ------------------ | ------ |
| Applicability      | 3      |
| Preparation Effort | 4      |
| Complexity         | 3      |
| Coverage           | 5      |
| Business Impact    | 5      |
| Visibility         | 4      |
| Resilience         | 2      |
| Reproducibility    | 5      |
| Interoperability   | N/A    |
| Overall Rating     | 3,89   |

To evaluate the measure, the example CiliumNetworkPolicy from Listing 2 was configured according to the aforementioned specifications. Subsequently, the proper functionality of the CiliumNetworkPolicy was verified using the commands from Listing 3. Specifically, it was tested whether connections could be made to the websites [http://google.com](http://google.com) and [http://example.com](http://example.com) using different HTTP methods, and whether the web server remained accessible for requests from outside the cluster.

The measure could only be successfully executed in the Rancher test scenario, that uses the Cilium network plugin, resulting in a medium applicability (3). Nevertheless, a very high reproducibility (5) was demonstrated, as in each of the five executions within the Rancher test scenario, only the intended network connections were blocked. However, the measure can still be easily circumvented by configuring a custom CiliumNetworkPolicy during the attack, allowing attackers to retain access, which results in a low resilience (2).

Despite this, the measure achieved a very high coverage (5), as all network communication with the compromised application is blocked. The preparation effort is low (4), as only the relevant labels need to be applied, and the Cilium command-line interface needs to be installed. The complexity of this measure differs from previous ones, as although only three actions are required, identifying the necessary connections demands a high level of expertise, leading to a medium complexity (3).

The business impact differs significantly since, with the correct configuration of the necessary connections, the availability of the compromised application is not restricted (see Figure 2). Therefore, this measure can be classified as a long-term containment measure with very low business impact (5) and low visibility (4), as essentially only the network context of the compromised application is modified.

In conclusion, a solid overall rating of 3.89 was awarded.

##### Listing 3: Commands for checking the partial network isolation of the web server

```bash
curl -I http://localhost:30007 -m 5
kubectl exec <pod-name> -it -- curl -I http://www.google.com -m 5
kubectl exec <pod-name> -it -- curl -I http://www.google.com -m 5 -X POST
kubectl exec <pod-name> -it -- curl -I http://example.com -m 5
kubectl exec <pod-name> -it -- curl -I http://example.com -m 5 -X POST
```

##### Figure 2: Business impact of measure C-N-02
![Business impact of measure C-N-02](Dependency-Modeling-Diagram_C-N-02.png)