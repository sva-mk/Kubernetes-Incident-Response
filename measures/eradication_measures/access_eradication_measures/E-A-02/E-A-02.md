# E-A-02 Access Eradication by Restricting Access to ServiceAccountToken

Additionally, not only should unauthorized ServiceAccounts be removed, but the remaining ServiceAccounts should also be protected as much as possible. Therefore, access to the associated ServiceAccount tokens should be restricted as much as possible [[The23i](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/)]. In order to achieve this objective, it may be feasible to entirely remove the ServiceAccount token from the respective pod [[The23i](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/)]. An example configuration of a pod without a ServiceAccount token is shown in Listing 2 [[The23i](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/)]. However, there are cases where it is not possible to remove the ServiceAccount token from the pod, as one of the containers relies on the ability to authenticate with the Kubernetes API to perform its function [[The24o](https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/)]. In this case, it is possible to restrict which processes can access the ServiceAccount token [[Kub24b](https://docs.kubearmor.io/kubearmor/quick-links/deployment_guide)]. This prevents the ServiceAccount token from being compromised again if attackers still have access to the pod. The tool KubeArmor can again be used to manage the corresponding file accesses within the pod [[Kub23a](https://docs.kubearmor.io/kubearmor/use-cases/use-cases); [Kub24b](https://docs.kubearmor.io/kubearmor/quick-links/deployment_guide)]. The necessary preparations for installing KubeArmor and the associated command-line interface `karmor` can be found in the section on Measure [E-P-02](../../process_eradication_measures/E-P-02/). Building on these preparations, the following procedure can be used to configure a KubeArmorPolicy to restrict access to ServiceAccount tokens:

1. Identify labels to select the pods (see Listing 1, line 1) [[The24u](https://kubernetes.io/docs/reference/kubectl/quick-reference/); [Kub24b](https://docs.kubearmor.io/kubearmor/quick-links/deployment_guide)].
   - As with Measure [E-P-02](../../process_eradication_measures/E-P-02/), all pods to which the KubeArmorPolicy will apply must be selected using a label, and the selection is critical to the KubeArmorPolicy's functionality [[Kub23f](https://docs.kubearmor.io/kubearmor/documentation/security_policy_specification)].
   - In addition, the processes that require access to the ServiceAccount token must be identified.

2. Configure a KubeArmorPolicy to prevent unauthorized access to the pod's ServiceAccount token (see Listing 1, lines 2-3) [[Kub23e](https://docs.kubearmor.io/kubearmor/documentation/security_policy_examples); [Kub24b](https://docs.kubearmor.io/kubearmor/quick-links/deployment_guide)].
   - A template from the KubeArmor documentation can be adjusted to allow access to the ServiceAccount token only for legitimate processes [[Kub23d](https://docs.kubearmor.io/kubearmor/use-cases/least_permissive_access); [Kub23a](https://docs.kubearmor.io/kubearmor/use-cases/use-cases)].
   - For instance, the KubeArmorPolicy from Listing 3 can be used to grant access to the ServiceAccount token only to the applications `nginx` and `cat`, with the latter being allowed solely for testing purposes [[Kub23e](https://docs.kubearmor.io/kubearmor/documentation/security_policy_examples); [Kub24b](https://docs.kubearmor.io/kubearmor/quick-links/deployment_guide); [Kub23a](https://docs.kubearmor.io/kubearmor/use-cases/use-cases)].

3. Test the functionality of the KubeArmorPolicy (see Listing 1, lines 4-5) [[Kub24b](https://docs.kubearmor.io/kubearmor/quick-links/deployment_guide)].
   - Any program in the pod can be used to verify if access to the ServiceAccount token is still available.

##### Listing 1: Commands for limiting access to the ServiceAccount token in accordance with [[Kub23a](https://docs.kubearmor.io/kubearmor/use-cases/use-cases); [Kub23e](https://docs.kubearmor.io/kubearmor/documentation/security_policy_examples)]

```bash
kubectl get pods --show-labels
kubectl annotate ns <namespace> kubearmor-file-posture=block --overwrite
kubectl apply -f KubeArmorPolicy.yaml
kubectl exec -it <pod-name> -- bash -c "cat /var/run/secrets/kubernetes.io/
serviceaccount/token"
kubectl exec -it <pod-name> -- bash -c 'cd /var/run/secrets/kubernetes.io/
serviceaccount/ && echo "$(<token)"'
```


##### Listing 2:  Example YAML configuration for a pod without ServiceAccount token according to [[The23i](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/)]
```bash
apiVersion: v1
kind: Pod
metadata:
    name: nginx
spec:
    containers:
    - name: nginx-container
    image: nginx:latest
    automountServiceAccountToken: false
```

##### Listing 3:  Example YAML configuration for restricting access to the ServiceAccount token according to [[Kub23e](https://docs.kubearmor.io/kubearmor/documentation/security_policy_examples); [Kub24b](https://docs.kubearmor.io/kubearmor/quick-links/deployment_guide); [Kub23a](https://docs.kubearmor.io/kubearmor/use-cases/use-cases)]
```bash
apiVersion: security.kubearmor.com/v1
kind: KubeArmorPolicy
metadata:
  name: block-service-token
spec:
  selector:
    matchLabels:
      app: nginx
  file:
    matchPaths:
      - path: /root/.bashrc
      - path: /root/.bash_history
      - path: /dev/tty
    matchDirectories:
      - dir: /run/secrets/kubernetes.io/serviceaccount/
        recursive: true
        fromSource:
        - path: /bin/cat
        - path: /usr/sbin/nginx
      - dir: /etc/
        recursive: true
      - dir: /proc/
        recursive: true
      - dir: /bin/cat/
        recursive: true
  process:
    matchPaths:
    - path: /usr/sbin/nginx
    - path: /bin/bash
    - path: /bin/cat
  action:
    Allow
```


## Evaluation

The following table, entitled *Evaluation of measure E-A-02*, provides an overview of the evaluation of the aforementioned measure. The composition of the overall rating is then described in detail.

#### Table: Evaluation of E-A-02

| Criteria           | Result |
| ------------------ | ------ |
| Applicability      | 4      |
| Preparation Effort | 4      |
| Complexity         | 2      |
| Coverage           | 4      |
| Business Impact    | 5      |
| Visibility         | 2      |
| Resilience         | 2      |
| Reproducibility    | 5      |
| Interoperability   | N/A    |
| Overall Rating     | 3,79   |


To evaluate the measure, the KubeArmorPolicy from Listing 3 was implemented in each of the test scenarios following the outlined procedure. It was then verified whether access to the ServiceAccount token via bash and cat was still possible. Since the KubeArmorPolicy explicitly allows access to the token only for cat and nginx, the implementation of the measure was considered successful only if no direct access via bash was possible. It was observed that by using KubeArmor, this measure, like [E-P-02](../../process_eradication_measures/E-P-02/), exhibits high applicability (4) and low resilience (2), as it could be successfully implemented in three out of four test scenarios, but, as described above, could be easily bypassed by configuring a custom KubeArmorPolicy.

Similarly, the preparation effort for this measure is considered low (4), as only three actions are required to install the command-line tool `karmor` and implement KubeArmor in the cluster, all of which involve minimal effort [[Kub24b](https://docs.kubearmor.io/kubearmor/quick-links/deployment_guide)]. The complexity of this measure is also high (2), as detailed expertise is needed to identify the processes that still require access to the ServiceAccount token. Moreover, the measure, like [E-P-02](../../process_eradication_measures/E-P-02/), has very high reproducibility (5) and a high coverage (4), as consistently identical results were achieved, addressing the TTPs T1190 [[The23ax](https://attack.mitre.org/techniques/T1190/)], T1528 [[The23bd](https://attack.mitre.org/techniques/T1528/)], T1613 [[The23au](https://attack.mitre.org/techniques/T1613/)], and T1069 [[The23ba](https://attack.mitre.org/techniques/T1069/)]. Similarly, the business impact (5) and visibility (2) of the measure are identical to [E-P-02](../../process_eradication_measures/E-P-02/), as no applications are affected when handled correctly, yet the KubeArmorPolicy allows intervention in the process, file, and network context.

The most significant difference from [E-P-02](../../process_eradication_measures/E-P-02/) is the interoperability of the results, as here, reading the KubeArmor logs was omitted, resulting in no direct outcomes and the measure being rated as "N/A" in this regard. Overall, the measure received a score of 3.79.

##### Figure 1: Business impact of measure E-A-02
![Business impact of measure E-A-02](Dependency-Modeling-Diagram_E-A-02.png)
