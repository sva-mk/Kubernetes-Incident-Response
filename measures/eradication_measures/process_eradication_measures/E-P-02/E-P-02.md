# E-P-02 Process Eradication by Removing Unauthorized Applications

In general, compromised systems are often exploited by attackers for their own benefit, whether to carry out further attacks or to gain financial advantage [[CS19](https://www.f5.com/labs/articles/threat-intelligence/attackers-use-new--sophisticated-ways-to-install-cryptominers); [The21b](https://attack.mitre.org/techniques/T1583/005/)]. This behavior has been observed for many years [[MPM14, p.34ff](http://cisweb.bristolcc.edu/~ik/Download/Forensic/Incident_Response_Computer_Forensics_3rd_Edition.pdf)]. This practice is also applied in the context of cyberattacks on Kubernetes [[Lak23](https://thehackernews.com/2023/03/new-cryptojacking-operation-targeting.html)]. Therefore, it can be assumed that in the context of cryptojacking incidents, malicious applications such as a cryptominer are executed within the cluster without the authorization of the affected organization [[Lak23](https://thehackernews.com/2023/03/new-cryptojacking-operation-targeting.html); [AG23](https://www.crowdstrike.com/blog/crowdstrike-discovers-first-ever-dero-cryptojacking-campaign-targeting-kubernetes/)]. Various Kubernetes objects such as DaemonSets or Deployments can be used for the operation of cryptominers [[Lak23](https://thehackernews.com/2023/03/new-cryptojacking-operation-targeting.html); [AG23](https://www.crowdstrike.com/blog/crowdstrike-discovers-first-ever-dero-cryptojacking-campaign-targeting-kubernetes/)]. Attackers may also use individual pods to secure long-term access to the cluster independently of the Kubernetes API, as they generally expect their primary access points to be discovered and blocked at some point [[MPM14, p.611ff](http://cisweb.bristolcc.edu/~ik/Download/Forensic/Incident_Response_Computer_Forensics_3rd_Edition.pdf)]. For this reason, it is equally important to inspect the running pods and associated applications in the cluster to remove unauthorized workloads. In the context of Kubernetes, the following procedure can be used:

1. **Identification of unauthorized applications** (see Listing 1 line 1) [[The24u](https://kubernetes.io/docs/reference/kubectl/quick-reference/)].
   - Initially, the pods or associated deployments isolated as part of measure [E-P-01](../E-P-01/) should be removed. Additionally, it should be verified whether any other unauthorized applications are present. The organization’s internal information and application documentation should be used to ensure that only unauthorized applications are removed, avoiding the deletion of regular applications.

2. **Removal of unauthorized applications** (see Listing 1 line 3) [[The24u](https://kubernetes.io/docs/reference/kubectl/quick-reference/)].
   - The command in line 3 allows for the removal of deployments by specifying a space-separated list of objects. Any other objects associated with the identified applications can be removed in the same way.
   - If newly discovered applications are removed that were not previously isolated on the respective node, the associated node should be identified for further removal of artifacts (see Listing 1 line 2).

3. **Verification of the complete removal of unauthorized applications** (see Listing 1 line 4) [[The24u](https://kubernetes.io/docs/reference/kubectl/quick-reference/)].
   - The list of all pods in the cluster is searched again by the name of the removed Kubernetes object.

##### Listing 1: Commands for removing unauthorised applications according to [[The24u](https://kubernetes.io/docs/reference/kubectl/quick-reference/); [Ama23a](https://aws.github.io/aws-eks-best-practices/security/docs/incidents/)]

```bash
kubectl get pods --all-namespaces --output=’custom-columns=NAMESPACE:.metadata.namespace,POD:.metadata.name,CONTROLLED_BY:.metadata.ownerReferences[0].name’
kubectl get pods <podname> -n <namespace> -o=jsonpath=’{.spec.nodeName}{"\n"}’
kubectl delete deployments.apps -n <namespace> <names>
kubectl get pods --all-namespaces --output=’custom-columns=NAMESPACE:.metadata.namespace,POD:.metadata.name,CONTROLLED_BY:.metadata.ownerReferences[0].name’ | grep <objektname>
```

## Evaluation

The following table, entitled *Evaluation of measure E-P-02*, provides an overview of the evaluation of the aforementioned measure. The composition of the overall rating is then described in detail.

#### Table: Evaluation of E-P-02

| Criteria           | Result |
| ------------------ | ------ |
| Applicability      | 5      |
| Preparation Effort | 5      |
| Complexity         | 3      |
| Coverage           | 1      |
| Business Impact    | 5      |
| Visibility         | 1      |
| Resilience         | 4      |
| Reproducibility    | 5      |
| Interoperability   | 3      |
| Overall Rating     | 4,00   |

The measure was executed five times in the experimental environment for evaluation, and in each test scenario, the cryptominer was successfully identified and removed. Hence, both the applicability and reproducibility of the measure are very high (5). Additionally, the preparation effort and business impact of the measure are very low (5), as the necessary functions are already integrated into Kubernetes, and no authorized applications should be affected if handled correctly. Moreover, the resilience of the measure is high (4), since even static containers are displayed in the overview, making it difficult to bypass the measure. Attackers would need to completely mimic a legitimate organization’s application to integrate their own functions, which could then bypass the identification of unauthorized applications.

However, the measure has moderate complexity (3), as although only three actions need to be performed, identifying unauthorized applications in a productive cluster can be a challenge. Furthermore, the measure has very high visibility (1), as the removal of unauthorized pods alters all contexts. Since the measure only prevents attackers from maintaining permanent access to the cluster and continuing to exploit it, the coverage of the measure is very low (1). Additionally, the interoperability of the results is only at a moderate level (3), as the presented method only provides text-based output, with the command-line output being searched using ``grep`` for the removed Kubernetes objects. Overall, the measure received a good overall rating of 4.00.

##### Figure 1: Business impact of measure E-P-02
![Business impact of measure E-P-02](Dependency-Modeling-Diagram_E-P-02.png)
